name: Build

on:
  schedule:
    - cron: "0 0/2 * * *"
  workflow_dispatch:

concurrency:
  group: build-rules
  cancel-in-progress: true

permissions:
  contents: write

env:
  DOMAIN_DIR: domain
  IPCIDR_DIR: ipcidr
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"

jobs:
  convert:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Prepare environment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # pass token
        run: |
          # Save scripts to /tmp/scripts (before branch switched)
          cp -r scripts /tmp/scripts
          
          # Load shared functions
          source /tmp/scripts/functions.sh
          
          # Set release name
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M)" >> "$GITHUB_ENV"
          
          # Switch to rules branch
          switch_to_rules_branch
          
          # Delete and recreate directories
          rm -rf "$DOMAIN_DIR" "$IPCIDR_DIR"
          mkdir -p "$DOMAIN_DIR"/{hagezi,stamparm,oisd,loyalsoldier} \
                   "$IPCIDR_DIR"/{hagezi,stamparm,firehol,bitwire-it,loyalsoldier}
          
          # Install mihomo (from cached branch)
          install_mihomo

      - name: Convert rulesets
        env:
          LC_ALL: C
        run: |
          source /tmp/scripts/functions.sh
          
          # === URLs ===
          HAGEZI="https://raw.githubusercontent.com/hagezi/dns-blocklists/main"
          STAMPARM="https://raw.githubusercontent.com/stamparm"
          OISD="https://raw.githubusercontent.com/sjhgvr/oisd/main"
          FIREHOL="https://raw.githubusercontent.com/firehol/blocklist-ipsets/master"
          BITWIRE_IT="https://raw.githubusercontent.com/bitwire-it/ipblocklist/main"
          LOYALSOLDIER="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release"

          # (Optional) Override default values of `dl()` options
          # export DL_RETRY=3
          # export DL_RETRY_DELAY=5

          # === 1. HaGeZi Domains ===
          echo "[1/9] HaGeZi Domains"
          hagezi_wild="light multi:normal pro pro.mini pro.plus pro.plus.mini
            ultimate ultimate.mini tif tif.medium tif.mini doh
            doh-vpn-proxy-bypass dyndns spam-tlds spam-tlds-allow hoster"
          for item in $hagezi_wild; do
            src="${item%:*}" out="${item#*:}"
            proc_domain "$HAGEZI/wildcard/${src}-onlydomains.txt" "$DOMAIN_DIR/hagezi/${out}.mrs" "text"
          done

          for f in nrd7 nrd14-8 nrd21-15 nrd28-22 nrd35-29 \
                   dga7 dga14 dga30; do
            proc_domain "$HAGEZI/domains/${f}.txt" "$DOMAIN_DIR/hagezi/${f}.mrs" "text"
          done

          # === 2. HaGeZi IPs ===
          echo "[2/9] HaGeZi IPs"
          for f in tif doh; do
            proc_ip "$HAGEZI/ips/${f}.txt" "$IPCIDR_DIR/hagezi/${f}-ipcidr.mrs" "text"
          done

          # === 3. Stamparm Maltrail ===
          echo "[3/9] Stamparm maltrail"
          proc_domain "$STAMPARM/aux/master/maltrail-malware-domains.txt" \
            "$DOMAIN_DIR/stamparm/maltrail-malware.mrs" \
            "text"
          proc_mixed "$STAMPARM/aux/master/maltrail-static-trails.txt" \
            "$DOMAIN_DIR/stamparm/maltrail-static-domains.mrs" \
            "$IPCIDR_DIR/stamparm/maltrail-static-ipcidr.mrs" \
            "text" \
            ","  # use comma as separator

          # === 4. Stamparm Ipsum ===
          echo "[4/9] Stamparm ipsum"
          for i in 1 2 3 4; do
            proc_ip "$STAMPARM/ipsum/master/levels/${i}.txt" "$IPCIDR_DIR/stamparm/ipsum-level${i}.mrs" "text"
          done

          # === 5. OISD Domains ===
          echo "[5/9] OISD domains"
          for item in big:oisd_big small:oisd_small nsfw:oisd_nsfw nsfw_small:oisd_nsfw_small; do
            src="${item%:*}" out="${item#*:}"
            proc_domain "$OISD/domainswild2_${src}.txt" "$DOMAIN_DIR/oisd/${out}.mrs" "text"
          done

          # === 6. FireHOL IP Sets ===
          echo "[6/9] FireHOL ipsets"
          for f in firehol_level{1,2,3,4}.netset \
                   tor_exits.ipset \
                   tor_exits_{1,7,30}d.ipset \
                   firehol_anonymous.netset \
                   dm_tor.ipset \
                   et_tor.ipset; do
            proc_ip "$FIREHOL/${f}" "$IPCIDR_DIR/firehol/${f%.*}.mrs" "text"
          done

          # === 7. Bitwire-it ipblocklist ===
          echo "[7/9] bitwire-it ipblocklist"
          for f in inbound outbound; do
            proc_ip "$BITWIRE_IT/${f}.txt" "$IPCIDR_DIR/bitwire-it/${f%.*}.mrs" "text"
          done

          # === 8. Loyalsoldier clash-rules domains ===
          echo "[8/9] Loyalsoldier clash-rules domains"
          for f in apple direct gfw google greatfire icloud private proxy reject tld-not-cn; do
            proc_domain "$LOYALSOLDIER/${f}.txt" "$DOMAIN_DIR/loyalsoldier/${f%.*}.mrs" "yaml"
          done

          # === 9. Loyalsoldier clash-rules ips ===
          echo "[9/9] Loyalsoldier clash-rules ips"
          for f in cncidr lancidr telegramcidr; do
            proc_ip "$LOYALSOLDIER/${f}.txt" "$IPCIDR_DIR/loyalsoldier/${f%.*}.mrs" "yaml"
          done

          echo "[Done] Conversion completed"

      - name: Commit and push
        run: |
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
          git add "$DOMAIN_DIR" "$IPCIDR_DIR"

          if git diff --cached --quiet; then
            echo "[Git] No changes to commit"
            exit 0
          fi

          COMMIT_MESSAGE="release: ${RELEASE_NAME}"
          echo "[Git] Committing changes with message: ${COMMIT_MESSAGE}"
          git commit -m "$COMMIT_MESSAGE"

          echo "[Git] Pushing to rules branch (force push)"
          git push origin HEAD:rules --force                          # Avoid the infinite accumulation of large files in history
          echo "[Git] Push completed"

      - name: Purge jsDelivr cache
        # continue-on-error: true                                     # Optional
        run: |
          source /tmp/scripts/functions.sh

          shopt -s globstar nullglob
          for f in "$DOMAIN_DIR"/**/*.{mrs,txt} "$IPCIDR_DIR"/**/*.{mrs,txt}; do
            echo "Purging: $f"
            dl -r 2 "https://purge.jsdelivr.net/gh/${{ github.repository }}@rules/${f}" -o /dev/null &
          done
          wait
